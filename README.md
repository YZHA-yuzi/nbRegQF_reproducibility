README
================

In this document, we describe how to produce results included in our
manuscript for supporting our findings.

# Data

We have provided a simulated dataset `data_sim.rda`, which contains
simulated aggregated outcomes and simulated individual-level exposures
collected over 1000 time points. This dataset can also be generated by
running the R script `Simulations_data.R` we have provided.

# R scripts

-   `FUNs.R` (self-defined functions)
-   `FUNs_quan_Rcpp.cpp`
-   `Simulations_data.R`
-   `Simulations_known.R`
-   `Simulations_estquan.R`
-   `Simulations_errors.R`
-   `Sum_res_known.R`
-   `Sum_res_errors.R`
-   `Simulations_TabFig.R`

# Bash shell scripts

-   `sim_data.sh`
-   `fit_known.sh`
-   `est_quan.sh`
-   `fit_errors.sh`

# Intermediate results

The R script used for conducting the estimation of exposure quantile
functions which are temporally correlated across 1000 time points takes
4 hours to run. Additionally, in our simulation studies, we have
explored 6 scenarios and ran 100 simulations within each scenario. Thus,
we have provided intermediate results to generate table and figures
included in our manuscript.

-   `mu_cov_MVNprior.rda` (required to run `Simulations_errors.R`)
-   `Res_estquan.rda`; `dat_fig*i` where
    ![i=4,6](https://latex.codecogs.com/png.latex?i%3D4%2C6 "i=4,6");
    `Sum_betatau_QFknown_S*j`, `Sum_betatau_QFerrors*j`,
    `Sum_res_known_S*j`, `Sum_res_errors_S*j` where
    ![j=1,...,6](https://latex.codecogs.com/png.latex?j%3D1%2C...%2C6 "j=1,...,6");
    and a folder `cb_2015_us_zcta510_500k` (required to run
    `Simulations_TabFig.R`)

# Instructions for use

There are two options to run those provided R scripts: (1) RStudio or
(2) Bash Shell scripts. When running R codes in RStudio, please create a
new R project and make sure R scripts are stored at the same folder
where the created R project `*.Rproj` is; when running R codes using
provided bash shell scripts, please set the working directory to the
folder where R scripts and bash shell scripts are.

Run-time was approximated using a computer with 2.9 GHz 6-Core Intel
Core i9 and 32 Gb memory.

Steps to produce results presented in Section 4 are given below.

**Step 1**. Generate data (\~2.5 minutes)

Run `Simulations_data.R` in RStudio; or execute the bash script
`sim_data.sh` using the command `bash sim_data.sh` in terminal.

`data_sim.rda` will be saved to the working directory.

**Step 2**. Fit health models assuming quantile functions are known

Run `Simulations_known.R` in RStudio (arguments `simindex` and
`sceindex` have to be specified); or execute the bash script
`fit_known.sh`. One simulation takes about 40 seconds to run, we have a
total of 600 simulations (6 simulation scenarios, and 100 simulations
were conducted within each scenario).

`Res_Mean_known_S*j_*i.rda` and `Res_QF_known_S*j_*i.rda` will be saved
to a sub-directory named `inter_res`, where
![j=1,...,100](https://latex.codecogs.com/png.latex?j%3D1%2C...%2C100 "j=1,...,100")
and
![i=1,...,6](https://latex.codecogs.com/png.latex?i%3D1%2C...%2C6 "i=1,...,6").

**Step 3**. Estimate quantile functions (\~4 hours)

Run `Simulations_estquan.R` in RStudio; or execute the bash script
`est_quan.sh`.

`Res_estquan.rda` and `mu_cov_MVNprior.rda` will be saved to the
sub-directory `inter_res`.

**Step 4**. Fit the proposed model using estimated quantile functions

Run `Simulations_errors.R` in RStudio (arguments `simindex` and
`sceindex` have to be specified); or execute the bash script
`fit_errors.sh`. One simulation takes about 35 seconds to run, we have a
total of 600 simulations (6 simulation scenarios, and 100 simulations
were conducted within each scenario).

`Res_QF_errors_S*j_*i.rda` will be saved to the sub-directory
`inter_res`, where
![j=1,...,100](https://latex.codecogs.com/png.latex?j%3D1%2C...%2C100 "j=1,...,100")
and
![i=1,...,6](https://latex.codecogs.com/png.latex?i%3D1%2C...%2C6 "i=1,...,6").

**Step 5**. Summarize results Run `Sum_res_known.R` in RStudio (argument
`sce.index` has to be specified). Please follow instructions provided in
the R script to summarize results from fitting models assuming exposure
quantile functions are known. For each scenario, the R program takes \~6
minutes to run.

`Sum_res_known_S*i.rda` will be saved to the sub-directory `inter_res`,
where
![i=1,...,6](https://latex.codecogs.com/png.latex?i%3D1%2C...%2C6 "i=1,...,6").

Run `Sum_res_errors.R` in RStudio (argument `sce.index` has to be
specified). Please follow instructions provided in the R script to
summarize results from fitting models using estimated quantile
functions. For each scenario, the R program takes \~6 minutes to run.

`Sum_res_errors_S*i.rda` will be saved to the sub-directory `inter_res`,
where
![i=1,...,6](https://latex.codecogs.com/png.latex?i%3D1%2C...%2C6 "i=1,...,6").

**NOTE**: Because `Res_QF_errors_S*j_*i.rda` are too large, we did not
provide those results as intermediate results.

**Step 6**. Generate table and figures

**NOTE**: Since the health data cannot be shared, we did not provide R
codes to generate Figures 3 and 5.

Run `Simulations_TabFig.R` in RStudio. Please follow instructions
provided in the R script to generate Table 1, Figures 1, 2, 4, and 6.

`Fig1.png`, `Fig2.png`, `Fig4.png`, `Fig6.png`, and `Tab1.csv` will be
saved to a sub-directory `TabsFigs`.
